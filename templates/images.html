{% extends 'base.html' %}

{% block title %}Image Tools{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-4xl font-bold text-white mb-12">Image Tools</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        
        <!-- Resize by Pixels -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-green-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Resize by Pixels</h3>
            <p class="text-gray-400 mb-4">Resize image to specific dimensions</p>
            <form method="post" action="{% url 'resize_pixels' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="image" accept="image/*" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" required>
                <input type="number" name="width" placeholder="Width (px)" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" required>
                <input type="number" name="height" placeholder="Height (px)" class="w-full mb-4 bg-gray-700 text-white p-2 rounded" required>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">
                    Resize
                </button>
            </form>
        </div>

        <!-- Resize by File Size -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-green-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Resize by File Size</h3>
            <p class="text-gray-400 mb-4">Approximate target file size</p>
            <form method="post" action="{% url 'resize_filesize' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="image" accept="image/*" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" required>
                <input type="number" name="size" placeholder="Target size" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" step="0.1" required>
                <select name="unit" class="w-full mb-4 bg-gray-700 text-white p-2 rounded">
                    <option value="kb">KB</option>
                    <option value="mb">MB</option>
                </select>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">
                    Resize
                </button>
            </form>
        </div>

        <!-- Crop Image -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-green-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Crop Image</h3>
            <p class="text-gray-400 mb-4">Upload and drag to select crop area</p>
            
            <form method="post" action="{% url 'crop_image' %}" enctype="multipart/form-data" id="crop-form">
                {% csrf_token %}
                <input type="file" id="crop-image-input" accept="image/*" name="image" class="w-full mb-3 bg-gray-700 text-white p-2 rounded" required>
                
                <div id="crop-editor" style="display: none;" class="mb-4">
                    <!-- Image Preview with Crop Box -->
                    <div class="relative bg-gray-900 rounded overflow-hidden mb-3 flex justify-center" style="max-height: 250px;">
                        <img id="crop-preview-img" class="max-h-full max-w-full" alt="Crop Preview">
                        <div id="crop-box" class="absolute border-2 border-green-500 cursor-move" style="display: none; background: rgba(34,197,94,0.1);"></div>
                    </div>
                    
                    <!-- Coordinate Inputs -->
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="crop-left" name="left" placeholder="Left (px)" class="bg-gray-700 text-white p-2 rounded text-sm" value="0" min="0">
                        <input type="number" id="crop-top" name="top" placeholder="Top (px)" class="bg-gray-700 text-white p-2 rounded text-sm" value="0" min="0">
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <input type="number" id="crop-right" name="right" placeholder="Right (px)" class="bg-gray-700 text-white p-2 rounded text-sm" value="100">
                        <input type="number" id="crop-bottom" name="bottom" placeholder="Bottom (px)" class="bg-gray-700 text-white p-2 rounded text-sm" value="100">
                    </div>
                </div>
                
                <input type="hidden" name="image_data" id="crop-image-data">
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">
                    Crop
                </button>
            </form>
        </div>

        <!-- Compress Image -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-green-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Compress Image</h3>
            <p class="text-gray-400 mb-4">Reduce image file size</p>
            <form method="post" action="{% url 'compress_image' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="image" accept="image/*" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" required>
                <input type="range" name="quality" min="10" max="95" value="75" class="w-full mb-2">
                <span class="text-gray-300 text-sm">Quality: <span id="quality-value">75</span>%</span>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition mt-4">
                    Compress
                </button>
            </form>
        </div>

        <!-- Create Collage -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-green-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Create Collage</h3>
            <p class="text-gray-400 mb-4">Combine images into a grid collage</p>
            <form method="post" action="{% url 'create_collage' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="images" multiple accept="image/*" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" required>
                <input type="number" name="cols" placeholder="Columns" min="1" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" value="2" required>
                <input type="number" name="spacing" placeholder="Spacing (px)" class="w-full mb-4 bg-gray-700 text-white p-2 rounded" value="5">
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">
                    Create
                </button>
            </form>
        </div>

    </div>

    {% if message %}
    <div class="mt-8 p-4 bg-green-900 border border-green-600 text-green-300 rounded">
        {{ message }}
    </div>
    {% endif %}

    {% if error %}
    <div class="mt-8 p-4 bg-red-900 border border-red-600 text-red-300 rounded">
        {{ error }}
    </div>
    {% endif %}
</div>

<script>
    document.querySelector('input[name="quality"]').addEventListener('input', function(e) {
        document.getElementById('quality-value').textContent = e.target.value;
    });

    // Crop Image with Visual Rectangle
    let cropData = { left: 0, top: 0, right: 100, bottom: 100, imgWidth: 0, imgHeight: 0 };
    let isDragging = false;
    let startX, startY;

    document.getElementById('crop-image-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                // Store actual image dimensions
                cropData.imgWidth = img.width;
                cropData.imgHeight = img.height;
                cropData.left = 0;
                cropData.top = 0;
                cropData.right = img.width;
                cropData.bottom = img.height;

                // Display preview and crop box
                document.getElementById('crop-preview-img').src = event.target.result;
                document.getElementById('crop-editor').style.display = 'block';
                document.getElementById('crop-box').style.display = 'block';
                
                // Update input values with actual dimensions
                updateCropBox();
                
                // Store base64 in hidden field
                document.getElementById('crop-image-data').value = event.target.result;
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    function updateCropBox() {
        const box = document.getElementById('crop-box');
        const img = document.getElementById('crop-preview-img');
        
        if (!img.offsetWidth || !img.offsetHeight) return;
        
        // Calculate scale: displayed size / actual size
        const scaleX = img.offsetWidth / cropData.imgWidth;
        const scaleY = img.offsetHeight / cropData.imgHeight;

        // Position and size the visual box based on actual image coordinates scaled to display size
        box.style.left = (cropData.left * scaleX) + 'px';
        box.style.top = (cropData.top * scaleY) + 'px';
        box.style.width = ((cropData.right - cropData.left) * scaleX) + 'px';
        box.style.height = ((cropData.bottom - cropData.top) * scaleY) + 'px';

        // Update input fields with actual image pixel values
        document.getElementById('crop-left').value = Math.round(cropData.left);
        document.getElementById('crop-top').value = Math.round(cropData.top);
        document.getElementById('crop-right').value = Math.round(cropData.right);
        document.getElementById('crop-bottom').value = Math.round(cropData.bottom);
    }

    // Drag crop box
    const cropBox = document.getElementById('crop-box');
    
    cropBox.addEventListener('mousedown', function(e) {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;

        const img = document.getElementById('crop-preview-img');
        
        // Calculate scale: actual image size / displayed size
        const scaleX = cropData.imgWidth / img.offsetWidth;
        const scaleY = cropData.imgHeight / img.offsetHeight;
        
        const deltaX = (e.clientX - startX) * scaleX;
        const deltaY = (e.clientY - startY) * scaleY;

        const width = cropData.right - cropData.left;
        const height = cropData.bottom - cropData.top;

        // Move the crop box keeping it within bounds
        cropData.left = Math.max(0, Math.min(cropData.left + deltaX, cropData.imgWidth - width));
        cropData.top = Math.max(0, Math.min(cropData.top + deltaY, cropData.imgHeight - height));
        cropData.right = cropData.left + width;
        cropData.bottom = cropData.top + height;

        startX = e.clientX;
        startY = e.clientY;
        updateCropBox();
    });

    document.addEventListener('mouseup', function() {
        isDragging = false;
    });

    // Update from input fields
    ['crop-left', 'crop-top', 'crop-right', 'crop-bottom'].forEach(id => {
        document.getElementById(id).addEventListener('input', function(e) {
            const key = id.replace('crop-', '');
            cropData[key] = Math.max(0, parseInt(e.target.value) || 0);
            
            // Validate bounds
            if (cropData.left >= cropData.right) cropData.right = cropData.left + 1;
            if (cropData.top >= cropData.bottom) cropData.bottom = cropData.top + 1;
            if (cropData.right > cropData.imgWidth) cropData.right = cropData.imgWidth;
            if (cropData.bottom > cropData.imgHeight) cropData.bottom = cropData.imgHeight;
            
            updateCropBox();
        });
    });
</script>
{% endblock %}
