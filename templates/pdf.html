{% extends 'base.html' %}

{% block title %}PDF Tools{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-4xl font-bold text-white mb-12">PDF Tools</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        
        <!-- Merge PDFs (with ordering) -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-blue-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Merge PDFs</h3>
            <p class="text-gray-400 mb-4">Select PDFs and reorder them (drag or use arrows) before merging</p>
            <div>
                {% csrf_token %}
                <input type="hidden" id="merge-csrf" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <input type="file" id="merge-pdfs-input" multiple accept=".pdf" class="w-full mb-3 bg-gray-700 text-white p-2 rounded">

                <div id="merge-file-list" class="space-y-2 mb-3">
                    <!-- file items will be injected here -->
                </div>

                <div class="flex gap-2">
                    <button id="merge-submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition" disabled>
                        Merge
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Page -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-blue-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Delete Page</h3>
            <p class="text-gray-400 mb-4">Remove a specific page from PDF</p>
            <form method="post" action="{% url 'delete_page' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="pdf" accept=".pdf" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" required>
                <input type="number" name="page_num" placeholder="Page number" class="w-full mb-4 bg-gray-700 text-white p-2 rounded" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                    Delete
                </button>
            </form>
        </div>

        <!-- PDF to Images -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-blue-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">PDF to Images</h3>
            <p class="text-gray-400 mb-4">Convert PDF pages to image files</p>
            <form method="post" action="{% url 'pdf_to_images' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="pdf" accept=".pdf" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" required>
                <select name="format" class="w-full mb-4 bg-gray-700 text-white p-2 rounded">
                    <option value="png">PNG</option>
                    <option value="jpg">JPG</option>
                </select>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                    Convert
                </button>
            </form>
        </div>

        <!-- Images to PDF -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-blue-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Images to PDF</h3>
            <p class="text-gray-400 mb-4">Convert image files to PDF</p>
            <form method="post" action="{% url 'images_to_pdf' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="images" multiple accept="image/*" class="w-full mb-4 bg-gray-700 text-white p-2 rounded" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                    Convert
                </button>
            </form>
        </div>

        <!-- Add Watermark -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-blue-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Add Watermark</h3>
            <p class="text-gray-400 mb-4">Add text watermark to PDF pages</p>
            <form method="post" action="{% url 'watermark_pdf' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="pdf" accept=".pdf" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" required>
                <input type="text" name="text" placeholder="Watermark text" class="w-full mb-4 bg-gray-700 text-white p-2 rounded" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                    Apply
                </button>
            </form>
        </div>

        <!-- Encrypt/Decrypt -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-blue-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Encrypt/Decrypt</h3>
            <p class="text-gray-400 mb-4">Protect or unlock PDF with password</p>
            <form method="post" action="{% url 'encrypt_pdf' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="pdf" accept=".pdf" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" required>
                <input type="password" name="password" placeholder="Password" class="w-full mb-4 bg-gray-700 text-white p-2 rounded" required>
                <select name="action" class="w-full mb-4 bg-gray-700 text-white p-2 rounded">
                    <option value="encrypt">Encrypt</option>
                    <option value="decrypt">Decrypt</option>
                </select>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                    Apply
                </button>
            </form>
        </div>

        <!-- Compress PDF -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-blue-500 transition">
            <h3 class="text-xl font-bold text-white mb-4">Compress PDF</h3>
            <p class="text-gray-400 mb-4">Reduce PDF to target file size</p>
            <form method="post" action="{% url 'compress_pdf' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="pdf" accept=".pdf" class="w-full mb-2 bg-gray-700 text-white p-2 rounded" required>
                <div class="flex gap-2 mb-2">
                    <input type="number" name="size" placeholder="Target size" class="flex-1 bg-gray-700 text-white p-2 rounded" step="0.1" required>
                    <select name="unit" class="bg-gray-700 text-white p-2 rounded">
                        <option value="kb">KB</option>
                        <option value="mb">MB</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                    Compress
                </button>
            </form>
        </div>

    </div>

    {% if message %}
    <div class="mt-8 p-4 bg-green-900 border border-green-600 text-green-300 rounded">
        {{ message }}
    </div>
    {% endif %}

    {% if error %}
    <div class="mt-8 p-4 bg-red-900 border border-red-600 text-red-300 rounded">
        {{ error }}
    </div>
    {% endif %}
</div>

<script>
// PDF Merge ordering UI
const mergeInput = document.getElementById('merge-pdfs-input');
const mergeList = document.getElementById('merge-file-list');
const mergeBtn = document.getElementById('merge-submit');
let filesArray = [];

function renderList(){
    mergeList.innerHTML = '';
    filesArray.forEach((file, idx) => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between bg-gray-900 p-2 rounded border border-gray-700';

        const left = document.createElement('div');
        left.className = 'flex items-center gap-3';
        const handle = document.createElement('div');
        handle.className = 'text-gray-400 cursor-move';
        handle.textContent = '☰';
        const name = document.createElement('div');
        name.className = 'text-gray-200 text-sm';
        name.textContent = file.name;
        left.appendChild(handle);
        left.appendChild(name);

        const controls = document.createElement('div');
        controls.className = 'flex items-center gap-2';

        const up = document.createElement('button');
        up.type = 'button';
        up.className = 'px-2 py-1 bg-gray-700 rounded hover:bg-gray-600 text-sm text-white';
        up.textContent = '↑';
        up.onclick = () => { if(idx>0){ [filesArray[idx-1], filesArray[idx]] = [filesArray[idx], filesArray[idx-1]]; renderList(); } };

        const down = document.createElement('button');
        down.type = 'button';
        down.className = 'px-2 py-1 bg-gray-700 rounded hover:bg-gray-600 text-sm text-white';
        down.textContent = '↓';
        down.onclick = () => { if(idx<filesArray.length-1){ [filesArray[idx+1], filesArray[idx]] = [filesArray[idx], filesArray[idx+1]]; renderList(); } };

        const remove = document.createElement('button');
        remove.type = 'button';
        remove.className = 'px-2 py-1 bg-red-700 rounded hover:bg-red-600 text-sm text-white';
        remove.textContent = 'Remove';
        remove.onclick = () => { filesArray.splice(idx,1); renderList(); };

        controls.appendChild(up);
        controls.appendChild(down);
        controls.appendChild(remove);

        item.appendChild(left);
        item.appendChild(controls);
        mergeList.appendChild(item);
    });
    mergeBtn.disabled = filesArray.length < 2;
}

mergeInput.addEventListener('change', (e) => {
    const list = Array.from(e.target.files);
    // Append to filesArray
    filesArray = filesArray.concat(list);
    renderList();
    // Clear input to allow re-adding same file if needed
    mergeInput.value = '';
});

// Submit via fetch with FormData preserving order
mergeBtn.addEventListener('click', async () => {
    if(filesArray.length < 1) return;
    const fd = new FormData();
    // Add CSRF token
    const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if(csrf) fd.append('csrfmiddlewaretoken', csrf.value);

    filesArray.forEach(f => fd.append('pdfs', f));

    mergeBtn.disabled = true;
    mergeBtn.textContent = 'Merging...';

    try{
        const resp = await fetch('{% url "merge_pdf" %}', {
            method: 'POST',
            body: fd,
        });
        if(!resp.ok) throw new Error('Server error ' + resp.status);

        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'merged.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }catch(err){
        alert('Merge failed: ' + err.message);
    }finally{
        mergeBtn.disabled = false;
        mergeBtn.textContent = 'Merge';
    }
});
</script>

{% endblock %}
